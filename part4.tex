
\section{Протоколы общения дрона и наземной станции}
\subsection{Структура пакета}
Рассмотрим подробнее устройство MAVLink. Ниже приведена структура пакета MAVLink v2. Представление в памяти может отличаться.

uint8\_t magic;              //Метка начала

uint8\_t len;                //Размер данных / длина полезной нагрузки (сообщения)

uint8\_t incompat\_flags;     //Обратно несовместимые флаги

uint8\_t compat\_flags;       //Обратно совместимые флаги

uint8\_t seq;                //Порядковый номер сообщения для выявления потери сообщения

uint8\_t sysid;              //ID системы-отправителя

uint8\_t compid;             //ID компонента-отправителя

uint8\_t msgid 0:7;          //ID сообщения (первый байт), от него зависит, какие данные будут лежать в полезной нагрузке пакета

uint8\_t msgid 8:15;         //ID сообщения (второй байт)

uint8\_t msgid 16:23;        //ID сообщения (третий байт)

uint8\_t payload[max 255];   //Полезная нагрузка (размер сообщения максимум 255 байт) 

uint16\_t checksum;          //Контрольная сумма

uint8\_t signature[13];      //Сигнатура (опционально)

Структура пакета MAVLink v1 аналогична, но опускает incompat\_flags, compat\_flags и signature, и имеет только один байт для адреса сообщения.


\subsection{Публикация}
Беспроводной формат MAVLink оптимизирован для систем с ограниченными ресурсами и, следовательно, порядок полей не такой, как в спецификации XML. Беспроводной генератор сортирует все поля сообщения по размеру, сначала с самыми большими полями (uint64\_t), а затем с меньшими полями. Сортировка выполняется с использованием стабильного алгоритма сортировки, который гарантирует, что любые поля, которые не нужно переупорядочивать, останутся в том же относительном порядке. Это предотвращает проблемы с выравниванием в системах кодирования / декодирования и позволяет очень эффективно упаковывать / распаковывать.

\subsection{Многоадресные потоки и гарантированная доставка}
MAVLink создан для гибридных сетей, в которых высокоскоростные потоки данных от источников данных (беспилотных летательных аппаратов) поступают в приемники данных (наземные станции), но смешиваются с передачами, требующими гарантированной доставки. Ключевой вывод состоит в том, что для большинства потоков телеметрии не существует известного или единственного получателя: вместо этого, как правило, бортовой компьютер, наземная станция управления и облачная система нуждаются в одном и том же потоке данных.

С другой стороны, настройка бортовой миссии или изменение конфигурации системы с бортовыми параметрами требует точка-точка связи с гарантированной доставкой. MAVLink достигает очень высокой эффективности за счет использования обоих режимов работы.

\subsection{Режим топиков (публикация-подписка)}
%написать про топики и подписки
В режиме топиков протокол не будет выдавать идентификатор целевой системы и компонента для сообщений, чтобы сэкономить пропускную способность канала. Типичными примерами этого режима связи являются все потоки данных автопилота, такие как положение, координаты и т. д.

Основное преимущество этого режима заключается в том, что не создаются дополнительные накладные расходы, и все подписчики могут получать эти данные.

\subsection{Соединение точка-точка}% топология?

В режиме точка-точка MAV\-Link использует идентификатор цели и целевой компонент. В большинстве случаев, когда используются эти поля, подпротокол также обеспечивает гарантированную доставку (миссии, параметры, команды).

\subsection{Проверки целостности}
MAV\-Link реализует две проверки целостности: первая проверка целостности пакета во время передачи с использованием контрольной суммы X.25 ( $CRC-16-CCITT$ ). Однако это только гарантирует, что данные не были изменены в ссылке -- это не гарантирует согласованности с определением данных. Вторая проверка целостности связана с описанием данных, чтобы убедиться в содержании идентичной информации у двух сообщений с одинаковым идентификатором. Для этого само определение данных проходит через $CRC-16-CCITT$, а полученное значение используется для заполнения пакета CRC. Большинство эталонных реализаций хранят эту константу в массиве CRC\_EXTRA \cite{mavlink}.

% из хабра

Библиотека MAV\-Link позволяет кодировать и раскодировать пакеты согласно протоколу, но она не регламентирует, какими аппаратными и программными средствами данные будет отправлены — это могут быть TCP/UDP сообщения, обмен через последовательный порт, - все, что обеспечивает двухсторонний обмен. Библиотека обрабатывает входные данные побайтово, добавляя их в буфер и сама собирает из них пакет. Каждая система или компонент, может одновременно обмениваться данными по разным источникам, тогда для каждого источника назначается специальный идентификатор, называемый channel (канал). MAV\-Link содержит буфер на каждый канал.

%\url{https://habr.com/ru/post/312300/}

Канал связи
Протокол MAV\-Link может быть использован поверх следующих каналов связи:
последовательное соединение (UART, USB и др.);
UDP (Wi-Fi, Ethernet, 3G, LTE);
TCP (Wi-Fi, Ethernet, 3G, LTE).
Сообщение
MAV\-Link-сообщение это отдельная "порция" данных, передаваемая между устройствами. Отдельное MAV\-Link-сообщение содержит информацию о состоянии дрона или команду для дрона.

Примеры MAV\-Link-сообщений:
ATTITUDE, ATTITUDE\_QUATERNION – ориентация квадрокоптера в пространстве;
LOCAL\_POSITION\_NED – локальная позиция квадрокоптера;
GLOBAL\_POSITION\_INT – глобальная позиция квадрокоптера (широта/долгота/высота);
COMMAND\_LONG – команда для квадрокоптера (взлететь, сесть, переключить режим и т. д.).

%\url{https://clover.coex.tech/ru/mavlink.html}


%//осознанно переписать

%//подвести итог, чем полезно, как улучшить для наших целей(возможно, одна из задач на следующий семестр) 

