\section{Глава 2. Настройка дрона для передачи телеметрии и видеопотока на наземную станцию}

%\https://discuss.ardupilot.org/t/indoor-autonomous-flight-with-arducopter-ros-and-aruco-boards-detection/34699

\subsection{Настройка PX4}
Через конфигуратор qgroundcontrol на полетный контроллер загружается прошивка PX4, после чего необходима первоначальная настройка.

Последовательность действий:
\begin{itemize}
	\item указание прошивке на тип и схему БПЛА (квадрокоптер);
	\item калибровку датчиков (акселерометра, магнитометра, гироскопа...);
	\item проверка корректности ориентации датчиков положения -- акселерометра и гироскопа (отклонения по всем осям происходят в нужные стороны);
	\item конфигурация протокола радиоуправления;
	\item калибровка и настройка каналов радиоуправления (выставлены последовательно соответствующие оси и добавлены необходимые режимы);
	\item проверяется и задается последовательность моторов (порядковые номера моторов соответствуют используемым прошивкой полетного контроллера);
	\item проверяется направление вращений моторов и пропеллеров (диагональные моторы вращаются в одинаковых направлениях согласно выбранной схеме ЛА).
\end{itemize}

Часто в связи с некорректной настройкой одного из описанных пунктов возникают неконтролируемые ситуации при старте -- дрон отказывается взлетать или переворачивается при взлете.

Выставляются полетные режимы:

ACRO -- режим, где отклонением стиков задается угловая скорость для соответствующей оси дрона. Центральное положение стика означает нулевую угловую скорость; в то время как угловая скорость при крайнем положении настраивается значением системы рейтов. Таким образом, при нулевом положении стика дрон не возвращается в горизонт (отсутствует стабилизация уровня). Режим ACRO используется для акробатических полетов, когда требуется плавное и быстрое управление \cite{ardupilot}.

STABILIZED -- режим стабилизации дрона, когда стики аппаратуры находятся в центре; используется для ручного управления в ходе полетных испытаний внутри помещения.

POSHOLD -- удержание позиции по датчикам / компьютерному зрению; когда будет настроена система оценки положения дрона в пространстве, при включении указанного режима дрон должен держаться в одной точке с учетом погрешности.

OFFBOARD -- управление полетом с внешнего компьютера. Этот режим используется для программирования автономных полетов \cite{clover}, при котором управление происходит из выполняемой на внешнем компьютере программы.

После выполнения описанных в начале раздела шагов производится взлет в ручных режимах. Во время полета проверяется ПИД регулирование.

Настройка ПИД-регулятора производится стандартным методом step res\-ponse \cite{tau}. Суть метода заключается в передаче ступенчатого управляющего сигнала на вход регулятора и анализе реакции системы на него.
Медленная реакция на ступенчатый управляющий сигнал указывает на низкий коэффициент пропорциональной составляющей.
Коэффициент увеличивается до появления характерного перерегулирования.
После чего остаточные осцилляции гасятся путем повышения коэффициента дифференциальной составляющей.

Далее изменяются параметры для взаимодействия с Raspberry Pi: указывается используемый порт (UART) и бод-рейт 921600.
Для уменьшения задержки вместо всех mavlink сообщений на наземную станцию будут отправляться только сообщения внешнего визуального позиционирования.

Отключаются использование компаса и GPS, так как они не используются, и выставляются параметры для оценки положения по ECL.

Библиотека оценки и управления (ECL) использует алгоритм расширенного фильтра Калмана (EKF) для обработки измерений датчика и предоставления оценки следующих состояний:
\begin{itemize}
	\item кватернион, определяющий вращение из одной системы отсчета (North, East, Down локальной координатной плоскости) в другую ( X, Y, Z тела);
	\item скорость на IMU - North, East, Down (м / с);
	\item положение в IMU - North, East, Down (м);
	\item оценки смещения угла дельты IMU - X, Y, Z (рад);
	\item оценки смещения дельта-скорости IMU - X, Y, Z (м / с);
	\item компоненты магнитного поля Земли - North, East, Down (гаусс);
	\item смещение магнитного поля рамы кузова автомобиля - X, Y, Z (Гаусс);
	\item скорость ветра - север, восток (м / с).
\end{itemize}

EKF реализует систему "отложенного временного горизонта слияния", что позволяет учесть временные задержки опроса датчиков относительно IMU. Данные для каждого датчика буферизуются FIFO и извлекаются из буфера с помощью EKF для использования в нужное время. Компенсация задержки для каждого датчика регулируется параметрами EKF2*DELAY.

EKF имеет разные режимы работы, которые позволяют использовать различные комбинации опроса датчиков. При запуске фильтр проверяет минимальную жизнеспособную комбинацию датчиков и после завершения начального выравнивания наклона, рыскания и высоты входит в режим, который обеспечивает оценку вращения, вертикальной скорости, вертикального положения, отклонения угла отклонения IMU и отклонения дельта-скорости IMU.

Для этого режима требуются данные IMU, источник рыскания (магнитометр или система внешнего визуального позиционирования (external vision)) и источник данных о высоте. Этот минимальный набор данных требуется для всех режимов работы EKF. Затем данные других датчиков можно использовать для оценки дополнительных состояний \cite{px4}.

В качестве системы внешнего визуального позиционирования используется RPi c камерой.

%https://docs.px4.io/master/en/advanced_config/tuning_the_ecl_ekf.html

%https://docs.px4.io/master/en/ros/external_position_estimation.html
%https://docs.px4.io/master/en/peripherals/mavlink_peripherals.html

\subsection{Настройка Raspberry Pi}

Для RPi выбрана операционная система raspbian stretch lite.
%http://www.pcds.fi/downloads/operatingsystem/debianbased/raspbian/archive/stretch/raspbian.stretch.html
С помощью команд, представленных в листинге \ref{lst:5}, был записан образ на карту памяти микрокомпьютера.
\begin{Program}[H]
	\caption{Подготовка карты памяти для RPi} \label{lst:5}
\begin{MyCode}
$ unzip -p 2018-11-13-raspbian-stretch-lite.zip
$ sudo dd if=/home/qw/2018-11-13-raspbian-stretch-lite.img of=/dev/sdd
$ sync
\end{MyCode}
Для подключения к роутеру изменены параметры wpa\_supplicant.conf.

\begin{MyCode}
$ less /etc/wpa_supplicant/wpa_supplicant.conf
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=RU

network={
	ssid="ИМЯ_ТОЧКИ_ДОСТУПА"
	psk=passwd
}
\end{MyCode}
\end{Program}
%https://habr.com/ru/post/419947/
Для возможности удаленного подключения создан файл ssh в каталоге /boot.

После произведенных шагов карта памяти устанавливается в RPi, и с помощью утилиты nmap на наземной станции проверяются все подключения к роутеру (листинг \ref{lst:6}).
\begin{Program}[H]
	\caption{Поиск адресов в подсети роутера} \label{lst:6}
\begin{MyCode}
$ sudo nmap -sn 192.168.1.0/24
...
Nmap scan report for 192.168.1.148
Host is up (-0.062s latency).
MAC Address: B8:27:EB:D3:B7:09 (Raspberry Pi Foundation)
Nmap scan report for ikherty (192.168.1.28)
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 4.42 seconds
...
\end{MyCode}
\end{Program}
192.168.1.148 -- адрес Raspberry Pi.
%https://www.raspberrypi.org/documentation/remote-access/ip-address.md
Производится удаленное подключение по ssh по найденному адресу, и устанавливаются пакеты gstreamer для запуска трансляции видео с борта дрона.
Для обмена данными между полетным контроллером и RPi устанавливается пакет ser2net и в конфигурационном файле /etc/ser2net.conf добавляется строка, определяющая способ общения, в данном случае она выглядит так (листинг \ref{lst:7}):
\begin{Program}[H]
	\caption{Параметры для обмена сообщениями между полетным контроллером и RPi} \label{lst:7}
\begin{MyCode}
2000:raw:0:/dev/ttyAMA0:115200 8DATABITS NONE 1STOPBIT
\end{MyCode}
\end{Program}

Для использования RPi камеры в качестве источника данных трансляции производится сборка gst-rpicamsrc из репозитория \url{https://github.com/thaytan/gst-rpicamsrc} с помощью команд, представленных в листинге \ref{lst:8}:
\begin{Program}[H]
	\caption{Сборка rpicamsrc} \label{lst:8}
\begin{MyCode}
$ git clone https://github.com/thaytan/gst-rpicamsrc
$ cd gst-rpicamsrc
$ make
$ make install
\end{MyCode}
\end{Program}

Все необходимые изменения внесены, далее следует произвести настройку наземной станции.
